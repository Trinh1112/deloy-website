name: Build & Deploy Coffeeshop BE

on:
  push:
    branches: [ "main" ]

concurrency:
  group: deploy-coffeeshop-be
  cancel-in-progress: true

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ${{ secrets.DH_USER }}/coffeeshop-backend
      IMAGE_TAG: latest
      SHORT_SHA: ${{ github.sha.substr(0,7) }}
    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DH_USER }}
          password: ${{ secrets.DH_TOKEN }}

      - name: Build & Push image
        uses: docker/build-push-action@v5
        with:
          context: ./Backend
          file: ./Backend/Dockerfile
          push: true
          # gắn 3 tags: latest, full sha, short sha
          tags: |
            ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}
            ${{ env.IMAGE_NAME }}:${{ github.sha }}
            ${{ env.IMAGE_NAME }}:${{ env.SHORT_SHA }}
          provenance: false
          sbom: false

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to VPS (sync repo & restart services)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          envs: DH_USER,DH_TOKEN,GH_DEPLOY_KEY,REPO_SSH,APP_DIR
          script: |
            set -euo pipefail

            # ---------- cấu hình ----------
            REPO_SSH="${REPO_SSH:-git@github.com:Trinh1112/deloy-website.git}"
            APP_DIR="${APP_DIR:-$HOME/deloy-website}"

            echo "[INFO] REPO_SSH=$REPO_SSH"
            echo "[INFO] APP_DIR=$APP_DIR"

            # ---------- chuẩn bị SSH để pull repo qua SSH ----------
            mkdir -p ~/.ssh && chmod 700 ~/.ssh
            if [ -n "${GH_DEPLOY_KEY:-}" ]; then
              printf '%s\n' "$GH_DEPLOY_KEY" > ~/.ssh/id_ed25519
              chmod 600 ~/.ssh/id_ed25519
              cat > ~/.ssh/config <<'EOF'
Host github.com
  HostName github.com
  User git
  IdentityFile ~/.ssh/id_ed25519
  IdentitiesOnly yes
EOF
              chmod 600 ~/.ssh/config
              ssh-keyscan -H github.com >> ~/.ssh/known_hosts 2>/dev/null || true
              chmod 644 ~/.ssh/known_hosts
            fi

            # ---------- sync code ----------
            if [ ! -d "$APP_DIR/.git" ]; then
              mkdir -p "$(dirname "$APP_DIR")"
              cd "$(dirname "$APP_DIR")"
              git clone "$REPO_SSH" "$(basename "$APP_DIR")"
              cd "$APP_DIR"
            else
              cd "$APP_DIR"
            fi

            git fetch --all --prune
            git reset --hard origin/main
            # giữ file .env nếu bạn đang đặt tại thư mục gốc project
            git clean -fd -e .env

            # ---------- login Docker Hub ----------
            if [ -n "${DH_USER:-}" ] && [ -n "${DH_TOKEN:-}" ]; then
              echo "${DH_TOKEN}" | docker login -u "${DH_USER}" --password-stdin || true
            fi

            # ---------- deploy ----------
            docker compose pull || true
            docker compose up -d --pull always --remove-orphans
            docker image prune -f || true
            docker compose ps
    env:
      REPO_SSH: ${{ secrets.REPO_SSH }}
      APP_DIR: ${{ secrets.APP_DIR }}
      DH_USER: ${{ secrets.DH_USER }}
      DH_TOKEN: ${{ secrets.DH_TOKEN }}
      GH_DEPLOY_KEY: ${{ secrets.GH_DEPLOY_KEY }}
